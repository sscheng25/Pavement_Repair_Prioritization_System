---
title: "El_Paso_exploratory_analysis"
author: "Sisun Cheng"
date: "2022/1/22"
output:
  html_document:
    toc: yes
    toc_float: TRUE
    code_folding: hide
editor_options:
  chunk_output_type: inline
---
## Set up

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, results = FALSE, message = FALSE)
```


```{r libraries, message=FALSE, warning=FALSE, results='hide'}
library(tidyverse)
library(sf)
library(lubridate)
library(tigris)
library(tidycensus)
library(gganimate)
library(viridis)
library(riem)
library(gridExtra)
library(knitr)
library(kableExtra)
library(RSocrata)
library(caret)
library(purrr)
library(FNN)
library(stargazer)
library(dplyr)
library(spatstat)
library(raster)
library(spdep)
library(grid)
library(mapview)
library(stringr)
library(ggcorrplot)

palette5 <- c("#eff3ff","#bdd7e7","#6baed6","#3182bd","#08519c")
palette4 <- c("#D2FBD4","#92BCAB","#527D82","#123F5A")
palette4_2 <- c("#83c8f9","#2984c3","#075d9a","#000066")
palette2 <- c("#6baed6","#08519c")

```

```{r add plot and map themes for default visualizations, message=FALSE, warning=FALSE}
mapTheme <- function(base_size = 12) {
  theme(
    text = element_text( color = "black"),
    plot.title = element_text(size = 16,colour = "black"),
    plot.subtitle=element_text(face="italic"),
    plot.caption=element_text(hjust=0),
    axis.ticks = element_blank(),
    panel.background = element_blank(),axis.title = element_blank(),
    axis.text = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(colour = "black", fill=NA, size=2),
    strip.text.x = element_text(size = 14))
}

plotTheme <- function(base_size = 12) {
  theme(
    text = element_text( color = "black"),
    plot.title = element_text(size = 16,colour = "black"),
    plot.subtitle = element_text(face="italic"),
    plot.caption = element_text(hjust=0),
    axis.ticks = element_blank(),
    panel.background = element_blank(),
    panel.grid.major = element_line("grey80", size = 0.1),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(colour = "black", fill=NA, size=2),
    strip.background = element_rect(fill = "grey80", color = "white"),
    strip.text = element_text(size=12),
    axis.title = element_text(size=12),
    axis.text = element_text(size=10),
    plot.background = element_blank(),
    legend.background = element_blank(),
    legend.title = element_text(colour = "black", face = "italic"),
    legend.text = element_text(colour = "black", face = "italic"),
    strip.text.x = element_text(size = 14)
  )
}

```

```{r read in keys for Sisun, message=FALSE, warning=FALSE, include=FALSE}
# UNCOMMENT THE LINE BELOW IF YOU ARE RUNNING THE RMD
#source("Sisun.R")
```

```{r read in keys for Jenna, message=FALSE, warning=FALSE, include=FALSE}
# UNCOMMENT THE LINE BELOW IF YOU ARE RUNNING THE RMD
# source("Jenna.R")
```

```{r read in keys for Kristin, message=FALSE, warning=FALSE, include=FALSE}
# UNCOMMENT THE LINE BELOW IF YOU ARE RUNNING THE RMD
 source("Kristin.R")
```

```{r load data sources in github repo, message=FALSE, warning=FALSE, results='hide'}
# Projection CRS: ESRI 102339 (NAD_1983_HARN_StatePlane_Texas_Central_FIPS_4203).
# Spatial unit: meter.
CIP_layer <- st_read("Data/Resurfacing/CIP_PRogram_Master_Layer.shp") %>%
  st_transform('ESRI:102339')

centerline_with_age <- st_read("Data/PCI_Study/Centerline_with_Age.shp") %>%
  st_transform('ESRI:102339')

EPCenterline <- st_read("Data/Penn/EPCenterline.shp") %>%
  st_transform('ESRI:102339')

zoning <- st_read("Data/Penn/Zoning.shp") %>%
  st_transform('ESRI:102339')

# Saved as .csv from file 'POTHOLES2013_2021.xls'
potholes <- read_csv("Data/POTHOLES2013_2021.csv")

# Sheet 'Waze for Cities Data _ Key Aler' saved as .csv from file 'Waze for Cities Data _ Key Alerts Dashboard_Traffic Alerts_Table.xlsx'
waze_data <- read_csv("Data/Waze for Cities Data3.csv")

VMT <- read_csv("Data/ElPaso_VMT_res_bg.csv")

crash18 <- st_read("Data/CRIS2018/CRIS2018.shp")

# Note: The "el_paso_pass2" shapefile is too large for our GitHub repository, so it is read in for each team member using .source() - each person has a source file with local file paths and keys.

```

```{r cleaning EPCenterlines data}
# create an index so that each segment has a unique id
EPCenterline$index <- 1:nrow(EPCenterline)

# remove some unneeded columns
EPCenterline <- EPCenterline %>%
  dplyr::select(-POD_ALIAS1, -POD_ALIAS2, -POD_ALIAS3, -POD_ALIAS4, -STS_ALIAS4 , -STN_ALIAS4, -PRD_ALIAS4 , -STS_ALIAS3, -PRD_ALIAS3, -STS_ALIAS2, -PRD_ALIAS2, -STS_ALIAS1, -PRD_ALIAS1, -STR, -STL, -ESNL, -ESNR)
```


Boundary data of El Paso County downloaded from [Texas Open Data Portal](https://data.texas.gov/dataset/Texas-Counties-Map/48ag-x9aa).

```{r boundary data of El Paso county and city, message=FALSE, warning=FALSE, results='hide'}
texas <-
  st_read("Data/TexasCountiesMap.geojson")

El_Paso <-
  texas %>%
  filter(name=='El Paso') %>%
  st_as_sf(coords = the_geom.coordinates, crs = 4326, agr = "constant") %>%
  st_transform('ESRI:102339')

El_Paso_city <-
  st_read("Data/TxDOT_City_Boundaries.geojson") %>%
  filter(CITY_NM=='El Paso') %>%
  st_transform('ESRI:102339')

#ggplot() +
#  geom_sf(data = El_Paso_city, fill="grey") +
#  mapTheme()

```

```{r read in el paso city boundary, message=FALSE, warning=FALSE}
El_Paso_city <-
  st_read("Data/TxDOT_City_Boundaries.geojson") %>%
  filter(CITY_NM=='El Paso') %>%
  st_transform('ESRI:102339')

#writing out for arcmap processing
#st_write(El_Paso_city, "ElPaso_CityBound.shp")
```


## El Paso Demographics (Race, Ethnicity, Age data from 2019 5yr ACS)

```{r census_demographics}
# census data
# keys are read in from each team member's private files

#variable list for ACS 2019 5 year data
ACSvar <- load_variables(year = 2019, dataset = "acs5", cache = TRUE)

#loading race data by tract - use E variables for estimate values
EP_race <-
  get_acs(geography = "tract",
          variables = c("B01003_001E", #total_pop
                        "B02001_002E", #white alone
                        "B02001_003E", #black or african american
                        "B02001_004E", #american indian or alaska native
                        "B02001_005E", #asian alone
                        "B02001_006E", #native hawaiian or pacific islander
                        "B02001_007E", #some other race
                        "B02001_008E"), #two or more races
          year = 2019,
          state = 48,      # 48 for Texas
          geometry = TRUE,
          county = 141,    # 141 for El Paso county
          output = "wide") %>%
  rename(total_pop =  B01003_001E,
         white = B02001_002E,
         black = B02001_003E,
         NAT = B02001_004E,
         asian = B02001_005E,
         PI = B02001_006E,
         other = B02001_007E,
         two_plus = B02001_008E) %>%
  dplyr::select("GEOID","NAME","total_pop","white","black","NAT","asian","PI","other","two_plus","geometry")%>% #drop MOE columns
  mutate(pctWhite = white/total_pop*100,
         pctBlack = black/total_pop*100,
         pctNAT = NAT/total_pop*100,
         pctAsian = asian/total_pop*100,
         pctPI = PI/total_pop*100,
         pctOther = other/total_pop*100,
         pctTwo_plus = two_plus/total_pop*100)

#loading ethnicity data by tract - use E variables for estimate values
EP_ethnicity <-
  get_acs(geography = "tract",
          variables = c("B01003_001E", #total_pop
                        "B03001_002E", #not hispanic or latino
                        "B03001_003E"), #hispanic or latino
          year = 2019,
          state = 48,
          geometry = TRUE,
          county = 141,
          output = "wide") %>%
  rename(total_pop =  B01003_001E,
         notHL = B03001_002E,
         HL = B03001_003E) %>%
  dplyr::select("GEOID","NAME","total_pop","notHL","HL","geometry")%>% #drop MOE columns
  mutate(pctNotHL = notHL/total_pop*100,
         pctHL = HL/total_pop*100)
```


```{r census_demographics_age}
#loading age data by tract - use E variables for estimate values
ageVar <- ACSvar %>%
  filter(concept=="SEX BY AGE")

ageVar <- ageVar %>% dplyr::select(name)

ageVar <- as.list(ageVar$name)%>%
  paste0("E")

EP_age <-
  get_acs(geography = "tract",
          variables = ageVar,
          year = 2019,
          state = 48,
          geometry = TRUE,
          county = 141,
          output = "wide")%>%
  dplyr::select("GEOID","NAME",all_of(ageVar),"geometry")

```

```{r census_age_var_labels}
ageVarLabels <- ACSvar %>%
  filter(concept=="SEX BY AGE")

ageVarLabels <- ageVarLabels %>% dplyr::select(name,label)

ageVarLabels$name <- ageVarLabels$name %>%
  paste0("E")

ageVarLabels$label <-gsub("!!", "", as.character(ageVarLabels$label))
ageVarLabels$label <-gsub("Estimate", "", as.character(ageVarLabels$label))
ageVarLabels$label <-gsub(":", "_", as.character(ageVarLabels$label))


ageVarLabels <- ageVarLabels %>% dplyr::rename(VAR_NAME = name)
ageVarLabels <- ageVarLabels %>% dplyr::rename(LABEL = label)


# COMMENTING OUT BELOW TESTING (JENNA)
#transposing, in case it is needed
#ageVarLabels_new <- ageVarLabels %>%
#  pivot_longer(!VAR_NAME, names_to = "col1", values_to = "col2") %>%
#  pivot_wider(names_from = "VAR_NAME", values_from = "col2")

#renaming by matching - test
#names(EP_age) <- ageVarLabels$LABEL[match(names(EP_age), ageVarLabels$VAR_NAME)]

```


```{r census_age_var_rename_match, message=FALSE, warning=FALSE}
EP_age_new <- EP_age %>%
      rename_at(as.vector(na.omit(ageVarLabels$VAR_NAME[match(names(EP_age), ageVarLabels$VAR_NAME)])),
               ~as.vector(na.omit(ageVarLabels$LABEL[match(names(EP_age), ageVarLabels$VAR_NAME)])))
```

```{r census_demo_age_charts, message=FALSE, warning=FALSE}
# transform data to long
EP_age_long <- EP_age_new%>%
  gather(variable, value, -geometry, -GEOID, -NAME)

# new column for sex
EP_age_long <- EP_age_long %>%
  dplyr::mutate(Sex=
                  case_when(
                    str_detect(EP_age_long$variable, "Male") ~ "Male",
                    str_detect(EP_age_long$variable, "Female") ~ "Female",
                        TRUE ~ "Total"))

EP_age_long_nototal<-EP_age_long[!(EP_age_long$Sex=="Total" | EP_age_long$variable=="Total_Male_" | EP_age_long$variable=="Total_Female_"),]


ggplot(EP_age_long_nototal, aes(x = value, y = variable, fill = Sex)) +
  geom_col() + plotTheme()
```

```{r census_demo_maps}
#plotting census demographics data
#race map

race_long <- EP_race%>%
  dplyr::select(GEOID,NAME, pctWhite, pctBlack, pctNAT, pctAsian, pctPI, pctOther, pctTwo_plus)%>%
  gather(variable, value, -geometry, -GEOID, -NAME)

race_vars <- unique(race_long$variable)
mapList <- list()

for(i in race_vars){
  mapList[[i]] <-
    ggplot() +
      geom_sf(data = filter(race_long, variable == i), aes(fill=value), colour=NA) +
      scale_fill_viridis(name="") +
      labs(title=i) +
      mapTheme()}

do.call(grid.arrange,c(mapList, ncol = 4, top = "Race by Census Tract"))

```

```{r census_demo_maps2}
#ethnicity map - Hispanic or Latino
ggplot()+
  geom_sf(data=EP_ethnicity, aes(fill=pctHL))+
  scale_fill_viridis()+
  labs(title="Percent Hispanic or Latino in 2019",
       subtitle="Census Tracts in El Paso, TX",
       caption = "Source: US Census, ACS 2019") + mapTheme()

```

## El Paso Socioeconomics (data from 2019 5yr ACS)
```{r census data}

EP_econ <-
  get_acs(geography = "tract",
          variables = c("B19013_001E", #median household income
                        "B25058_001E", #median rent
                        "B08301_001E", #people who have means of transportation to work
                        "B01003_001E"), #total pop
          year = 2019,
          state = 48,      # 48 for Texas
          geometry = TRUE,
          county = 141,    # 141 for El Paso county
          output = "wide") %>%
  rename(total_pop =  B01003_001E,
         med_hh_income = B19013_001E,
         med_rent = B25058_001E,
         transport_to_work = B08301_001E) %>%
  dplyr::select("GEOID","NAME","total_pop","med_hh_income","med_rent","transport_to_work","geometry")%>% #drop MOE columns
  mutate(pct_transport_to_work = (ifelse(total_pop > 0, transport_to_work / total_pop,0))*100)

```

```{r census_socioecon_maps, message=FALSE, warning=FALSE}
econ_long <- EP_econ%>%
  dplyr::select(GEOID,NAME, med_hh_income, med_rent, pct_transport_to_work)%>%
  gather(variable, value, -geometry, -GEOID, -NAME)

econ_vars <- unique(econ_long$variable)
mapList_econ <- list()

for(i in econ_vars){
  mapList_econ[[i]] <-
    ggplot() +
      geom_sf(data = filter(econ_long, variable == i), aes(fill=value), colour=NA) +
      scale_fill_viridis(name="") +
      labs(title=i) + mapTheme()
      }

do.call(grid.arrange,c(mapList_econ, ncol = 3, top = "Select Socioeconomics by Census Tract", bottom = "Source: US Census, ACS 2019"))
```

```{r census_socioecon_transport_map, message=FALSE, warning=FALSE}
#pct transport to work map
ggplot()+
  geom_sf(data=EP_econ, aes(fill=pct_transport_to_work))+
  scale_fill_viridis()+
  labs(title="Percent Population with Transportation to Work in 2019",
       subtitle="Census Tracts in El Paso, TX", caption="Source: US Census, ACS 2019") + mapTheme()
```

```{r census_socioecon_medhhinc_map, message=FALSE, warning=FALSE}
#median household inc map
ggplot()+
  geom_sf(data=EP_econ, aes(fill=med_hh_income))+
  scale_fill_viridis()+
  labs(title="Median Household Income 2019",
       subtitle="Census Tracts in El Paso, TX", caption="Source: US Census, ACS 2019") + mapTheme()
```

```{r census_socioecon_medrent_map, message=FALSE, warning=FALSE}
#median rent map
ggplot()+
  geom_sf(data=EP_econ, aes(fill=med_rent))+
  scale_fill_viridis()+
  labs(title="Median Rent ($) 2019",
       subtitle="Census Tracts in El Paso, TX", caption="Source: US Census, ACS 2019") + mapTheme()
```


## Bring in centerline and PCI information
```{r EP centerlines, message=FALSE, warning=FALSE}
# unique(EPCenterline$CLASS)

# subset centerline data to El Paso city maintained segments
EPCenterline <-
  EPCenterline %>%
  subset(MUNR == 'CITY OF EL PASO')

# Clip to el paso city boundary
EPCenterline <-
  EPCenterline %>%
  st_intersection(El_Paso_city, EPCenterline)


# delete duplicated "LOCAL" class
EPCenterline$CLASS[EPCenterline$CLASS == "LOCAL\r\n\r\n\r\n\r\n" | EPCenterline$CLASS == "LOCAL\r\n\r\n" | EPCenterline$CLASS == "LOCAL\r\n" | EPCenterline$CLASS == "LOCAL\r\n\r\n\r\n"] <- "LOCAL"
unique(EPCenterline$CLASS)

ggplot() +
  geom_sf(data = EPCenterline, aes(color = CLASS)) +
  labs(title = "Centerlines with class",
       subtitle = "El Paso, TX") + mapTheme()

# unique(EPCenterline$CLASS)
ggplot(EPCenterline, aes(y=CLASS)) +
  geom_bar(width=0.5, color="black", fill = "#FF6666") +
  labs(title = "Pavement Center Lines by Class",
       subtitle = "El Paso, TX") + plotTheme()

```


```{r explore centerline data with PCI values from 2018}
EPCenterline_with_PCI <-
  EPCenterline %>%
  st_join(centerline_with_age)

ggplot(EPCenterline_with_PCI, aes(y=CLASS)) +
  geom_bar(width=0.5, color="black", fill = "#FF6666") +
  labs(title = "Pavement Center Lines by Class",
       subtitle = "El Paso, TX") + plotTheme()

ggplot(EPCenterline_with_PCI, aes(y=STATUS)) +
  geom_bar(width=0.5, color="black", fill = "#FF6666") +
  labs(title = "Pavement Center Lines by status",
       subtitle = "El Paso, TX") + plotTheme()

class_PCI <-
  EPCenterline_with_PCI %>%
  subset(STATUS == 'PAVED') %>%
  st_drop_geometry() %>%
  drop_na(PCI_2018) %>%
  group_by(CLASS) %>%
  summarise(PCI=mean(PCI_2018))

ggplot(class_PCI, aes(x=PCI, y=CLASS)) + 
  geom_bar(stat = "identity", color="black", fill = "#FF6666") +
  labs(title = "Average PCI value by Class",
       subtitle = "El Paso, TX") + plotTheme()

plan_area_PCI <-
  EPCenterline_with_PCI %>%
  st_drop_geometry() %>%
  subset(STATUS == 'PAVED') %>%
  drop_na(PCI_2018) %>%
  drop_na(PLANAREA) %>%
  group_by(PLANAREA) %>%
  summarise(PCI=mean(PCI_2018))

ggplot(plan_area_PCI, aes(x=PCI, y=PLANAREA)) + 
  geom_bar(stat = "identity", color="black", fill = "#FF6666") +
  labs(title = "Average PCI Value by Planning Area",
       subtitle = "El Paso, TX") + plotTheme()
```


```{r centerline data with MUNR City of El Paso, message=FALSE, warning=FALSE}
ggplot() +
  geom_sf(data = El_Paso_city, color="grey") +
  geom_sf(data = EPCenterline %>%
            subset(MUNR == 'CITY OF EL PASO'), colour="red",) +
  labs(title = "Centerline with MUNR CITY OF EL PASO",
       subtitle = "El Paso, TX") + mapTheme()
```


```{r centerline with age, message=FALSE, warning=FALSE}
# glimpse(centerline_with_age)

ggplot() +
  geom_sf(data = El_Paso_city, fill="transparent", color="red") +
  geom_sf(data = centerline_with_age, aes(color = PCI_2018)) +
  scale_color_viridis(direction=-1)+
  labs(title = "Street Centerlines with PCI 2018",
       subtitle = "El Paso, TX") + mapTheme()

# unique(center_line$PCI_2018)
ggplot(centerline_with_age, aes(y=PCI_2018)) +
  geom_bar(width=0.5, color="transparent", fill = "#FF6666") +
  labs(title = "PCI Distribution",
       subtitle = "El Paso, TX") + plotTheme()
```


```{r pavements with negative PCIs, message=FALSE, warning=FALSE}

negative_PCI_list <-
  centerline_with_age %>%
  subset(PCI_2018 < 0)

unique(negative_PCI_list$PCI_2018)

ggplot() +
  geom_sf(data = El_Paso_city, fill="transparent", color="red") +
  geom_sf(data = negative_PCI_list, aes(color = PCI_2018)) +
  labs(title = "PCI with a negative value",
       subtitle = "El Paso, TX") +mapTheme()

ggplot() +
  geom_sf(data = El_Paso_city, fill="transparent", color="red") +
  geom_sf(data = negative_PCI_list %>%
            subset(PCI_2018 == -1), aes(color = PCI_2018)) +
  labs(title = "PCI = -1",
       subtitle = "El Paso, TX") +mapTheme()

ggplot() +
  geom_sf(data = El_Paso_city, fill="transparent", color="red") +
  geom_sf(data = negative_PCI_list %>%
            subset(PCI_2018 == -2), aes(color = PCI_2018)) +
  labs(title = "PCI = -2",
       subtitle = "El Paso, TX") +mapTheme()

ggplot() +
  geom_sf(data = El_Paso_city, fill="transparent", color="red") +
  geom_sf(data = negative_PCI_list %>%
            subset(PCI_2018 == -4), aes(color = PCI_2018)) +
  labs(title = "PCI = -4",
       subtitle = "El Paso, TX") +mapTheme()

ggplot() +
  geom_sf(data = El_Paso_city, fill="transparent", color="red") +
  geom_sf(data = negative_PCI_list %>%
            subset(PCI_2018 == -6), aes(color = PCI_2018)) +
  labs(title = "PCI = -6",
       subtitle = "El Paso, TX") +mapTheme()

ggplot() +
  geom_sf(data = El_Paso_city, fill="transparent", color="red") +
  geom_sf(data = negative_PCI_list %>%
            subset(PCI_2018 == -7), aes(color = PCI_2018)) +
  labs(title = "PCI = -7",
       subtitle = "El Paso, TX") +mapTheme()

ggplot() +
  geom_sf(data = El_Paso_city, fill="transparent", color="red") +
  geom_sf(data = negative_PCI_list %>%
            subset(PCI_2018 == -8), aes(color = PCI_2018)) +
  labs(title = "PCI = -8",
       subtitle = "El Paso, TX") +mapTheme()

ggplot() +
  geom_sf(data = El_Paso_city, fill="transparent", color="red") +
  geom_sf(data = negative_PCI_list %>%
            subset(PCI_2018 == -9), aes(color = PCI_2018)) +
  labs(title = "PCI = -9",
       subtitle = "El Paso, TX") +mapTheme()

# write.csv(st_drop_geometry(negative_PCI_list), "C:/Users/CSS/Desktop/MUSA801/Data/negative_PCI_list.csv", row.names = FALSE)

# Zero PCI: an empty list
zero_PCI_list <-
  centerline_with_age %>%
  subset(PCI_2018 == 0)

```


```{r CIP_layer, message=FALSE, warning=FALSE}
# glimpse(CIP_layer)

ggplot() +
  geom_sf(data = CIP_layer, aes(color = PCI)) +
  labs(title = "PCI data from CIP layer",
       subtitle = "El Paso, TX") + mapTheme()

# unique(CIP_layer$PCI)
# unique(CIP_layer$DISTRICT)

```


```{r elpaso_pass, message=FALSE, warning=FALSE}
# glimpse(elpaso_pass)

ggplot() +
  geom_sf(data = elpaso_pass, color = "red") +
  labs(title = "elpaso_pass",
       subtitle = "El Paso, TX")

ggplot(elpaso_pass, aes(y=pci_2018)) +
  geom_bar(width=0.5, color="transparent", fill = "#FF6666") +
  labs(title = "PCI distribution of Elpaso_pass",
       subtitle = "El Paso, TX")
```

### Waze data exploration
```{r process the waze data 1, message=FALSE, warning=FALSE}
x_fin <- data.frame()
y_fin <- data.frame()

for (i in waze_data$Location) {
  pattern1 <- "Point(.*?) "
  pattern2 <- " (.*?))"

  x_coor <- regmatches(i, regexec(pattern1, i))
  x_temp <- x_coor[[1]][2] %>%
    substr(start=2, stop=99)
  #print(x_temp)
  x_fin <- rbind(x_fin, x_temp)
  y_coor <- regmatches(i, regexec(pattern2, i))
  y_temp <- y_coor[[1]][2]
  y_fin <- rbind(y_fin, y_temp)
}

x_fin$x_coor <- x_fin$X..106.598471.
y_fin$y_coor <- y_fin$X.31.911973.
waze_data$x_coor <- x_fin$x_coor
waze_data$y_coor <- y_fin$y_coor
```


```{r process waze jam data 2, message=FALSE, warning=FALSE}
waze_sf <-
  waze_data %>%
  st_as_sf(coords = c("x_coor", "y_coor"), crs = 4326, agr = "constant") %>%
  st_transform('ESRI:102339')

ggplot() +
  geom_sf(data = El_Paso_city, color="grey") +
  geom_sf(data = waze_sf, aes(colour=Subtype), size=0.5, show.legend = "point") +
  labs(title = "Waze jam data points by subtype",
       subtitle = "El Paso, TX") + mapTheme()

ggplot(waze_sf, aes(y=Subtype)) +
  geom_bar(width=0.5, color="transparent", fill = "#FF6666") +
  labs(title = "Waze jams numbers grouped by subtype",
       subtitle = "El Paso, TX") + plotTheme()
```


```{r waze data NAs, message=FALSE, warning=FALSE}
ggplot() +
  geom_sf(data = El_Paso_city, color="grey") +
  geom_sf(data = waze_sf %>%
            subset(is.na(Subtype)), color = "red", size=0.5, show.legend = "point") +
  labs(title = "Waze jam data points with NA subtype",
       subtitle = "El Paso, TX") + mapTheme()
```

### Potholes data exploration

```{r process pot holes data to sf, message=FALSE, warning=FALSE}
potholes_sf <-
  potholes %>%
  subset(WORKORDERID!=588771) %>%
  na.omit() %>%
  st_as_sf(coords = c("WOXCOORDINATE", "WOYCOORDINATE"),
           crs = 'epsg:2277',
           agr = "constant") %>%
  st_transform('ESRI:102339')

```


```{r grouping pot holes data by year 1, message=FALSE, warning=FALSE}
potholes_sf$YEAR <- format(mdy_hms(potholes_sf$ACTUALFINISHDATE), format='%Y')
glimpse(potholes_sf)

potholes_sf <-
  potholes_sf %>%
  subset(YEAR != 1900)

potholes_sf$YEAR <- potholes_sf$YEAR[potholes_sf$YEAR == 2106] <- 2016

```


```{r grouping pot holes data by year 2, message=FALSE, warning=FALSE}
# new sf with last five years of points data only for easier legibility on maps
potholes_sf_2015to2018 <- potholes_sf %>% dplyr::filter(YEAR > 2014 & YEAR < 2019)
potholes_sf_2019to2021 <- potholes_sf %>% dplyr::filter(YEAR > 2018)
potholes_sf_2018 <- potholes_sf %>% dplyr::filter(YEAR == 2018)
```


```{r 2018 streets and potholes map, message=FALSE, warning=FALSE}
# 2018 potholes map
ggplot() +
  geom_sf(data=EPCenterline, color="#585858", alpha=0.8) +
  geom_sf(data = potholes_sf_2018, size=0.2, color="blue", alpha=0.2) +
  geom_sf(data = El_Paso_city, fill="transparent", color="red") +
  guides(fill="legend")+
  labs(title = "Potholes and Centerlines in 2018",
       subtitle = "El Paso, TX") + mapTheme()
```

```{r lots of potholes maps, message=FALSE, warning=FALSE}
# 2015-2018 map
ggplot() +
  geom_sf(data = El_Paso_city, fill="grey") +
  geom_sf(data = potholes_sf_2015to2018, aes(colour=YEAR), size=0.2, show.legend = "point") +
  labs(title = "Potholes in 2015-2018",
       subtitle = "El Paso, TX") + mapTheme()

#  2019-2021 map
ggplot() +
  geom_sf(data = El_Paso_city, fill="grey") +
  geom_sf(data = potholes_sf_2019to2021, aes(colour=YEAR), size=0.2, show.legend = "point") +
  labs(title = "Potholes 2019-2021",
       subtitle = "El Paso, TX") + mapTheme()

ggplot(potholes_sf, aes(y=YEAR)) +
  geom_bar(width=0.5, color="black", fill = "#FF6666") +
  labs(title = "Year of pot holes repairment",
       subtitle = "El Paso, TX") + plotTheme()

```

### Joining data together

### Potholes data

```{r centerline buffer and potholes work}
#create centerline buffer of 24ft and centerline buffer
EPCenterline_buffer <- st_buffer(EPCenterline, dist=24) %>% st_as_sf()

#join potholes to EPCenterline_buffer using nearest feature
potholes_centerlines <-  st_join(potholes_sf, EPCenterline_buffer, join = st_nearest_feature)

#clean up to make it easier
potholes_centerlines_clean <- potholes_centerlines %>%
  dplyr::select(WORKORDERID, index) %>% st_drop_geometry()
```

```{r potholes per streetsegment and merging back with centerline data}
# count potholes per street segment
potholes_groupings <- potholes_centerlines_clean %>% 
  group_by(index) %>%
  summarize(potholes_count=n())

#then join back to initial EPCenterline using index as the ID
EPCenterline_new <- merge(EPCenterline, potholes_groupings, by = "index", all.x=TRUE)

#replace NAs in potholes count column with 0
EPCenterline_new$potholes_count[is.na(EPCenterline_new$potholes_count)] <- 0

```

```{r visualize street centerline segments by potholes count, message=FALSE, warning=FALSE}
# only mapping when potholes are greater than or equal to 1
ggplot() +
  geom_sf(data = El_Paso_city, fill="transparent", color="red") +
  geom_sf(data = EPCenterline_new, aes(color = potholes_count)) +
  scale_color_viridis(direction=-1, limits = c(1, 150))+
  labs(title = "Street Centerlines by Number of Potholes",
       subtitle = "El Paso, TX") + mapTheme()

```

```{r street centerlines by pothole count histogram}
# excluding segments with 0 potholes
ggplot(EPCenterline_new, aes(x=potholes_count)) + geom_histogram(fill="purple") + scale_x_continuous(limits = c(1, 150))

#including setgments with 0 potholes
ggplot(EPCenterline_new, aes(x=potholes_count)) + geom_histogram(fill="purple")


```

### Waze data

```{r join waze data into street buffer}
#join waze jam data to EPCenterline_buffer using nearest feature
waze_centerlines <-  st_join(waze_sf, EPCenterline_buffer, join = st_nearest_feature)

#clean up to make it easier
waze_centerlines_clean <- waze_centerlines %>%
  st_drop_geometry()
```


```{r waze jams per streetsegment and merging back with centerline data}
# count potholes per street segment
waze_groupings <- waze_centerlines_clean %>% 
  group_by(index) %>%
  summarize(waze_count=n())

#then join back to initial EPCenterline using index as the ID
EPCenterline_new <- merge(EPCenterline_new, waze_groupings, by = "index", all.x=TRUE)

#replace NAs in potholes count column with 0
EPCenterline_new$waze_count[is.na(EPCenterline_new$waze_count)] <- 0

```

### Crash data

```{r join crashes to centerlines}
#replace 0s in lat long columns with NA so we can omit
crash18$Latitude <- as.numeric(as.character(crash18$Latitude))

crash18['Latitude'=='0'] <- NA

#transforming to our crs
crash18_sf <- crash18 %>%
  na.omit() %>%
  st_as_sf(coords = c("Latitude", "Longitude"),
           crs = 'epsg:2277',
           agr = "constant") %>%
  st_transform('ESRI:102339')

#join crashes to EPCenterline_buffer using nearest feature
crash_centerlines <-  st_join(crash18_sf, EPCenterline_buffer, join = st_nearest_feature)

#clean up to make it easier
crash_centerlines_clean <- crash_centerlines %>%
  dplyr::select(Crash_ID, index) %>% st_drop_geometry()
```

```{r summarizing crashes by centerline}
#NEED TO FIX THIS CHUNK
# count crashes per street segment
crash_groupings <- crash_centerlines %>% 
  group_by(index) %>%
  summarize(crash_count=n())

#then join back to initial EPCenterline using index as the ID
EPCenterline_new <- merge(EPCenterline, crash_groupings, by = "index", all.x=TRUE)

#replace NAs in crash count column with 0
EPCenterline_new$crash_count[is.na(EPCenterline_new$crash_count)] <- 0
```


### Zoning data

```{r zoning map, message=FALSE, warning=FALSE}
# glimpse(zoning)

ggplot() +
  geom_sf(data = zoning, fill="grey") +
  labs(title = "Zoning",
       subtitle = "El Paso, TX") + mapTheme()

```

### VMT data

```{r VMT data}
census_geom <-
  EP_econ %>%
  subset(select = c("GEOID","geometry"))

# VMT <- read_csv("Data/ElPaso_VMT_res_bg.csv")

VMT$GEOID <- substr(VMT$FIPS, 1, 11)

VMT_sf <-
  census_geom %>%
  right_join(VMT, by="GEOID") %>%
  subset(id != 0) %>%
  group_by(GEOID) %>%
  summarise(VMT = sum(count)) %>%
  st_transform('ESRI:102339')

ggplot() +
  geom_sf(data = VMT_sf, aes(fill = VMT)) +
  labs(title = "VMT",
       subtitle = "El Paso, TX")

```


```{r merging VMT data into EPCenterline_new}
EPCenterline_new <- 
  EPCenterline_new %>%
  st_join(VMT_sf)

```

### Joining Census data into EPCenterline_new

```{r merging census data into EPcenterline}
EPCenterline_new <- 
  EPCenterline_new %>%
  left_join(EP_econ %>%
              st_drop_geometry(), by = 'GEOID') %>%
  left_join(EP_race %>%
              st_drop_geometry() %>%
              dplyr::select(GEOID, pctWhite), by = 'GEOID') %>%
  left_join(EP_ethnicity %>%
              st_drop_geometry() %>%
              dplyr::select(GEOID, pctNotHL), by = 'GEOID') 

```


```{r merging PCI and age data}
EPCenterline_with_PCI <-
  EPCenterline_new %>%
  st_join(centerline_with_age, join = st_intersects)

## need someone help me look into this dataframe
## EPCenterline_final has 76072 rows of data, but the left object (EPCenterline_new) in the left_join below has only 34224 rows
EPCenterline_final <-
  EPCenterline_new %>%
  left_join(EPCenterline_with_PCI %>%
              st_drop_geometry() %>%
              dplyr::select(index, PCI_2018, Res_Year), by = 'index') 

```


### TL_Roads data

```{r tl_roads_data}
#comparing TIGER/Line shapefile to the street centerlines shapefile from Alex
tl_roads <- st_read("Data/tl_2018_roads/tl_2018_48141_roads.shp") %>%
  st_transform('ESRI:102339')

ggplot(tl_roads, aes(y=RTTYP)) +
  geom_bar(width=0.5, color="black", fill = "#FF6666") +
  labs(title = "El Paso,TX Roads by RouteType",
       subtitle = "TIGER/Line 2018")
```


## El Paso Land Cover
Lots of raster data operations!

```{r read in el paso city land cover raster}
EPcity_landcover <-
  raster("Data/Data_NLCD/ElPasoArea_LandCover_ImperviousCover/NLCD_2019_Land_Cover_L48_20210604_hHjclStONh9yCsFQkZ5z.tiff")

# plot to see
plot(EPcity_landcover)
```

```{r reproject raster}
EPcity_landcover_reproject <- projectRaster(EPcity_landcover,
                                       crs = crs(El_Paso_city))
```

```{r crop and mask raster}
# Crop raster data by extent of state subset
EPcity_landcover_crop <- crop(EPcity_landcover_reproject, extent(El_Paso_city))

# Identify those pixels in raster that lie within the borders of the given shp. Use the 'mask' function for that.

EPcity_landcover_crop <- mask(EPcity_landcover_crop, El_Paso_city)
plot(EPcity_landcover_crop)

```


```{r create function for converting raster to df, message=FALSE, warning=FALSE}
rasterdf <- function(x, aggregate = 1) {
  resampleFactor <- aggregate        
  inputRaster <- x    
  inCols <- ncol(inputRaster)
  inRows <- nrow(inputRaster)
  # Compute numbers of columns and rows in the new raster for mapping
  resampledRaster <- raster(ncol=(inCols / resampleFactor), 
                            nrow=(inRows / resampleFactor))
  # Match to the extent of the original raster
  extent(resampledRaster) <- extent(inputRaster)
  # Resample data on the new raster
  y <- resample(inputRaster,resampledRaster,method='ngb')

  # Extract cell coordinates into a data frame
  coords <- xyFromCell(y, seq_len(ncell(y)))
  # Extract layer names
  dat <- stack(as.data.frame(getValues(y)))
  # Add names - 'value' for data, 'variable' to indicate different raster layers
  # in a stack
  names(dat) <- c('value', 'variable')
  dat <- cbind(coords, dat)
  dat
}

```

```{r convert NLCD raster to df}
# convert to df
EPcity_landcover_df <- rasterdf(EPcity_landcover_crop)
EPcity_landcover_df
```

```{r map codes to names and pull colors from TIFF legend, message=FALSE, warning=FALSE}
# library imports, just to make sure we have them all
library(colorspace)
library(rgdal)          
library(RColorBrewer) 
library(rasterVis)    
library(sp)

LCcodes <- c(11,12,21,22,23,24,31,41,42,43,52,71,81,82,90,95)

LCnames <-c(
  "Water",
  "IceSnow",
  "DevelopedOpen",
  "DevelopedLow",
  "DevelopedMed",
  "DevelopedHigh",
  "Barren",
  "DeciduousForest",
  "EvergreenForest",
  "MixedForest",
  "ShrubScrub",
  "GrassHerbaceous",
  "PastureHay",
  "CultCrops",
  "WoodyWetlands",
  "EmergentHerbWet")

LCcolors <- attr(EPcity_landcover, "legend")@colortable[LCcodes + 1]
names(LCcolors) <- as.character(LCcodes)
LCcolors

```

```{r map the final land cover raster, message=FALSE, warning=FALSE}
ggplot(data = EPcity_landcover_df) +
  geom_raster(aes(x = x, y = y, fill = as.character(value))) + 
  scale_fill_manual(name = "Land cover",
                    values = LCcolors,
                    labels = LCnames[-2],
                    na.translate = FALSE) +
  coord_sf(expand = F) +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        panel.background = element_rect(fill = "white", color = "black")) + mapTheme()

```

```{r map land cover and roads with PCI}
ggplot(data = EPcity_landcover_df) +
  geom_raster(aes(x = x, y = y, fill = as.character(value))) + 
  scale_fill_manual(name = "Land cover",
                    values = LCcolors,
                    labels = LCnames[-2],
                    na.translate = FALSE) +
  coord_sf(expand = F) +
    geom_sf(data = centerline_with_age, aes(color = PCI_2018)) +
  scale_color_viridis(direction=-1)+
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank()) + mapTheme()


```


## Correlation Matrix

```{r correlation Matrix}
numVars <-
  EPCenterline_new %>%
  dplyr::select(potholes_count, waze_count, VMT, total_pop, med_hh_income, med_rent, pct_transport_to_work, pctWhite, pctNotHL, Res_Year) %>%
  st_drop_geometry() %>%
  na.omit()

ggcorrplot(
  round(cor(numVars), 1), 
  p.mat = cor_pmat(numVars),
  colors = c("#25CB10", "white", "#FA7800"),
  type="lower",
  show.diag = TRUE,
  insig = "blank") +  
  labs(title = "Correlation Matrix for Numeric Variables") +
  theme(plot.title = element_text(hjust = 0.5)) +
  plotTheme()
```





